---
title: "3 types of Cartograms in R with {sf} and {cartogram}"
subtitle: ""
date: "2024-10-23"
author: "Aditya Dahiya"
bibliography: references.bib
format:
  html:
    code-fold: true
editor_options: 
  chunk_output_type: console
execute: 
  error: false
  message: false
  warning: false
  eval: false
filters:
  - social-share
  - custom-callout
share:
  permalink: "https://aditya-dahiya.github.io/visage/geocomputation/cartogram_types.html"
  description: "Visualizing Information and Spatial Analysis with ggplot2 Extensions"
  twitter: true
  linkedin: true
  email: true
  mastodon: true
  facebook: true
custom-callout:    
  keylearning:
    icon: true
    title: "Key Learning"
    icon-symbol: "fa-web-awesome"
    color: "#baddff"
---

::: keylearning
1.  Making cartgrams with {cartogram}
2.  Getting custom callouts with [Custom Callout Extension](https://quarto.thecoatlessprofessor.com/custom-callout/) for Quarto
3.  Getting `geom_sf_text()` with {ggrepel} effects
:::

1.  Getting libraries and raw data

```{r}
#| label: setup

library(tidyverse)         # Data Wrangling and ggplot2
library(sf)                # Spatial Objects in R
library(ggrepel)           # Repel Labels in plots
library(cartogram)         # Drawing different Cartograms
library(showtext)

cia_data <- openintro::cia_factbook |> 
  mutate(
    iso_a3 = countrycode::countrycode(country, "country.name", "iso3c")
  )

world_map <- rnaturalearth::ne_countries(
  scale = "small",
  returnclass = "sf"
  )

font_add_google("Saira Extra Condensed", "caption_font")
showtext_auto()

object.size(world_map) |> print(units = "Kb")
```

2.  Converting the data into a usable form - a clean tibble.

Displaying the Mercator Projection world map which will be used for being converted into a cartogram.

```{r}
#| label: tbl-data1
#| tbl-cap: "A world map with CRS 3857, i.e. Mercator Projection before it is converted into a cartogram"

world_map <- world_map |> 
  select(name, geometry, pop_est, iso_a3) |> 
  group_by(name) |> 
  slice_max(order_by = pop_est, n = 1) |> 
  left_join(cia_data) |> 
  filter(!is.na(population)) |> 
  st_transform(crs = 3857)

ggplot(world_map) +
  geom_sf() +
  theme_minimal()
```

3.  Converting `geometry` into Cartograms geometry using {cartogram} with Mercator projection (CRS 3857)

```{r}
#| label: cartograms-df
#| code-fold: false

# need first to "change" the projection to Mercator (AKA Google Maps): EPSG: 3857

world_map_cont <- cartogram::cartogram_cont(world_map, "population")

world_map_dorling <- cartogram::cartogram_dorling(world_map, "population")

world_map_ncont <- cartogram::cartogram_ncont(world_map, "population")
```

4.  A Continuous Cartogram

```{r}
#| label: fig-cont
#| fig-cap: ""

world_map_cont |> 
  ggplot(
    mapping = aes(
      fill = country,
      colour = country
    )
  ) +
  geom_sf(
    colour = "transparent"
  ) +
  geom_sf_text(
    mapping = aes(
      label = country,
      size = population,
      geometry = geometry
    ),
    family = "caption_font",
    fontface = "bold",
    check_overlap = TRUE
  ) +
  scale_size_continuous(
    range = c(1, 10)
  ) +
  scale_fill_manual(
    values = colorspace::lighten(
      paletteer::paletteer_d("palettesForR::Caramel"),
      0.3
    )
  ) +
  scale_colour_manual(
    values = colorspace::darken(
      paletteer::paletteer_d("palettesForR::Caramel"),
      0.3
    )
  ) +
  labs(
    x = NULL, y = NULL,
    title = "Cartogram of population - countries depicted as non-overlapping circles"
  ) +
  theme_minimal(
    base_family = "caption_font",
    base_size = 16
  ) +
  theme(
    legend.position = "none",
    panel.grid = element_line(
      colour = "grey90",
      linetype = 3,
      linewidth = 0.5
    )
  )
```

4.  A Non-continuous Cartogram

```{r}

world_map_ncont |> 
  ggplot(
    mapping = aes(
      fill = country,
      colour = country
    )
  ) +
  geom_sf(
    data = world_map,
    fill = "transparent",
    colour = alpha("grey50", 0.5)
  ) +
  geom_sf(
    colour = "transparent"
  ) +
  geom_sf_text(
    mapping = aes(
      label = country,
      size = population,
      geometry = geometry
    ),
    family = "caption_font",
    fontface = "bold",
    check_overlap = TRUE
  ) +
  scale_size_continuous(
    range = c(1, 10)
  ) +
  scale_fill_manual(
    values = colorspace::lighten(
      paletteer::paletteer_d("palettesForR::Caramel"),
      0.3
    )
  ) +
  scale_colour_manual(
    values = colorspace::darken(
      paletteer::paletteer_d("palettesForR::Caramel"),
      0.3
    )
  ) +
  labs(
    x = NULL, y = NULL,
    title = "Cartogram of population - countries depicted as non-overlapping circles"
  ) +
  theme_minimal(
    base_family = "caption_font",
    base_size = 16
  ) +
  theme(
    legend.position = "none",
    panel.grid = element_line(
      colour = "grey90",
      linetype = 3,
      linewidth = 0.5
    )
  )
```

4.  A Cartogram with each country as non-overlapping circles

(with geom_text_repel and stat = "sf_coordinates")

```{r}
#| label: fig-dorling
#| fig-cap: "Cartogram of population - countries depicted as non-overlapping circles"
#| fig-width: 10


world_map_dorling |> 
  ggplot(
    mapping = aes(
      fill = country,
      colour = country
    )
  ) +
  geom_sf(
    colour = "transparent"
  ) +
  geom_text_repel(
    mapping = aes(
      label = country,
      size = population,
      geometry = geometry
    ),
    stat = "sf_coordinates",
    force_pull = 100,
    force = 1,
    max.iter = 1000,
    max.time = 0.5,
    family = "caption_font",
    fontface = "bold"
  ) +
  scale_size_continuous(
    range = c(1, 10)
  ) +
  scale_fill_manual(
    values = colorspace::lighten(
      paletteer::paletteer_d("palettesForR::Caramel"),
      0.3
    )
  ) +
  scale_colour_manual(
    values = colorspace::darken(
      paletteer::paletteer_d("palettesForR::Caramel"),
      0.3
    )
  ) +
  labs(
    x = NULL, y = NULL,
    title = "Cartogram of population - countries depicted as non-overlapping circles"
  ) +
  theme_minimal(
    base_family = "caption_font",
    base_size = 16
  ) +
  theme(
    legend.position = "none",
    panel.grid = element_line(
      colour = "grey70",
      linetype = 3,
      linewidth = 0.5
    )
  )
```
