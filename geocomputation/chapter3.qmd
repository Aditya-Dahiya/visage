---
title: "Chapter 3: Attribute data operations"
subtitle: "Key Learnings from, and Solutions to the exercises in Chapter 3 of the book Geocomputation with R by Robin Lovelace, Jakub Nowosad and Jannes Muenchow."
date: "2024-11-08"
author: "Aditya Dahiya"
bibliography: references.bib
format:
  html:
    code-fold: true
editor_options: 
  chunk_output_type: console
execute: 
  error: false
  message: false
  warning: false
  eval: true
  cache: true
categories:
  - "Geocomputation with R"
  - "Textbook Solutions"
comments:
  giscus: 
    repo: Aditya-Dahiya/visage
filters:
  - social-share
  - custom-callout
custom-callout:    
  keylearning:
    icon: false
    title: "Relevant Topic"
    color: "#f0b3ff"
share:
  permalink: "https://aditya-dahiya.github.io/visage/geocomputation/chapter3.html"
  description: "Visualizing Information and Spatial Analysis with ggplot2 Extensions"
  twitter: true
  linkedin: true
  email: true
  mastodon: true
  facebook: true
---

### Prerequisites

-   `sf` for vector data manipulation ([link](https://r-spatial.github.io/sf/))
-   `terra` for raster data manipulation ([link](https://rspatial.org/terra/))
-   `dplyr` for data frame operations ([link](https://dplyr.tidyverse.org/))
-   `spData` for example datasets ([link](https://cran.r-project.org/web/packages/spData/index.html))

## 3.1 Introduction

-   **Attribute Data**: Non-spatial info tied to geographic data (e.g., bus stop name or elevation).
    -   **Vector Example**: A bus stop's location as POINT (-0.098 51.495) with attributes like its name.
    -   **Raster Example**: Pixel values represent attributes (e.g., elevation); location defined by matrix indices and resolution.
-   **Chapter Focus**:
    -   Manipulating geographic objects using attributes (e.g., names, elevations).
    -   Techniques: subsetting, aggregation, joining data, creating new variables.
    -   Vector and raster data operations are similar and interchangeable (e.g., subsetting, spatial joins).

```{r}
#| label: setup

library(sf)        # Handling Simple Features in R
library(terra)     # Handling Rasters in R
library(tidyverse) # Data Wrangling

library(spData)    # Spatial Data-sets
```

## 3.2 Vector Attribute Manipulation

-   **`sf` Package**:

    -   Extends base R's `data.frame` with a geometry column (`sfc` class) for spatial features (points, lines, polygons).
    -   Geometry column often named `geometry` or `geom`, but **customizable**.

-   **Manipulation Methods**:

    ```{r}
    #| label: tbl-methods-sf
    #| tbl-cap: "Methods available for the class 'sf' in R using {sf} package"

    methods(class = "sf") |> 
      as_tibble() |>
      rename(methods = x) |> 
      mutate(methods = str_replace_all(methods, ",sf", "  ")) |> 
      mutate(methods = str_replace_all(methods, ".sf", "  ")) |> 
      gt::gt() |> 
      gt::tab_header(
        title = "Methods available"
      ) |> 
      gt::opt_interactive()

    ```

    -   Methods like `aggregate()`, `cbind()`, `merge()`, and `rbind()` work seamlessly with `sf` objects.

    -   Compatible with tidyverse functions (`dplyr`, `tidyr`) and can be used with `data.table` (partial compatibility noted in issue [#2273](https://github.com/Rdatatable/data.table/issues/2273)).

    -   Dropping geometry (`st_drop_geometry()`) can speed up attribute data operations when spatial data is not required.

    ```{r}
    #| code-fold: false
    #| collapse: true

    # Original 'world' dataset
    dim(world)
    class(world)

    # Dropping the geometry column: Effects
    st_drop_geometry(world) |> 
      dim()
    st_drop_geometry(world) |> 
      class()
    ```

-   **Advantages**:

    -   `sf`'s integration with the tidyverse allows robust, efficient data manipulation.
    -   Compatible with tidyverse functions (e.g., `dplyr`), making it versatile for data analysis.

::: keylearning
**Major Pitfalls of Using Spatial Data with the Tidyverse**

1.  **Name Clashes**
    -   Functions like `select()` from [`dplyr`](https://dplyr.tidyverse.org/reference/select.html) can mask similar functions from the [`raster`](https://rspatial.github.io/raster/reference/select.html) package.
    -   Use fully qualified names (e.g., [`dplyr::select()`](https://dplyr.tidyverse.org/reference/select.html)) to avoid conflicts.
2.  **Compatibility Issues with `sp` Package**
    -   The older [`sp`](https://cran.r-project.org/web/packages/sp/index.html) package does not integrate well with tidyverse functions.
    -   Requires conversion between `sp` to [`sf`](https://r-spatial.github.io/sf/articles/sf1.html) object types using functions like [`st_as_sf()`](https://r-spatial.github.io/sf/reference/st_as_sf.html).
3.  **Handling Multipolygon Objects**
    -   Multiple geometries in objects can cause unexpected plotting results.
    -   Resolve issues by casting to simpler geometry types using `st_cast(to = "POLYGON")`.
4.  **Spatial Subsetting Challenges**
    -   Verbose syntax when using tidyverse functions like [`filter()`](https://dplyr.tidyverse.org/reference/filter.html) with spatial predicates like [`st_intersects()`](https://r-spatial.github.io/sf/reference/st_intersects.html).

    -   May result in altered row names, complicating joins and comparisons.

    -   Other option is spatial subsetting using base `R`

        ```{r}
        #| eval: false
        #| code-fold: false
        lnd_buff = lnd[1, ] %>% 
          st_transform(crs = 27700) %>%  # uk CRS
          st_buffer(500000) %>%
          st_transform(crs = 4326)
        near_lnd = world[lnd_buff, ]
        world_poly = world %>% 
          st_cast(to = "POLYGON")
        near_lnd_new = world_poly[lnd_buff, ]
        near_lnd_tidy = world %>% 
          filter(st_intersects(., lnd_buff, sparse = FALSE))
        ```
5.  **Row Name Alterations**
    -   Tidyverse operations may drop or alter row names, affecting joins and comparisons. See related discussion in [tidyverse/dplyr#366](https://github.com/tidyverse/dplyr/issues/366).
6.  **Attribute Alteration Pitfall**
    -   Results from tidyverse functions may differ from base R operations due to row name discrepancies.
    -   Example functions: [`filter()`](https://dplyr.tidyverse.org/reference/filter.html) vs base R subsetting (`[]`).
7.  **Issues with `bind_rows()`**
    -   [`bind_rows()`](https://dplyr.tidyverse.org/reference/bind.html) fails on spatial objects; use alternatives like setting geometries to NULL with [`st_set_geometry()`](https://r-spatial.github.io/sf/reference/st_set_geometry.html) before combining.
8.  **Limited Raster Data Support**
    -   Tidyverse integration with [`raster`](https://rspatial.github.io/raster/) data is minimal.
    -   Initial efforts like [`tabularaster`](https://cran.r-project.org/web/packages/tabularaster/index.html), [`sfraster`](https://cran.r-project.org/web/packages/sfraster/index.html), and [`stars`](https://r-spatial.github.io/stars/) aim to enhance support.
:::

### 3.2.1 Vector Attribute Sub-setting

-   **Base R Sub-setting**:
    -   Uses `[` operator and `subset()` function for rows and columns selection.

    -   Syntax: `object[i, j]` returns rows indexed by `i` and columns by `j`.
-   **`dplyr` Sub-setting Functions**:
    -   `filter()` and `slice()` for rows, `select()` for columns.

    -   **`select()`**: Subsets columns by name or position.

    -   Helper functions in `select()` like `contains()`, `starts_with()`, `num_range()`.
-   **Extracting a Single Column**:
    -   Use `pull()` (`dplyr`), `$`, or `[[` (base `R`).
-   **Row Selection**:
    -   **`slice()`**: Selects rows by index.

    -   **`filter()`**: Filters rows based on conditions.
-   **Comparison Operators**:
    -   Standard operators can be used in `filter()`: `<`, `>`, `<=`, `>=`, `==`, `!=`.

The `dplyr` functions (`filter()`, `select()`, `pull()`) are intuitive and integrate well with the tidyverse workflows.

### 3.2.2 Chaining Commands with Pipes

-   **Pipe Operator**:
    -   **`%>%`** (from the **`magrittr`** package) and native **`|>`** (from R 4.1.0 onwards) enable chaining commands, improving readability and flow of code.
    -   The output of one function becomes the input of the next.
    -   Alternative: Nested Function Calls: The same operation without pipes uses nested functions, which is harder to read.
-   **Splitting into Multiple Lines**:
    -   Useful for debugging and inspecting intermediate results but can clutter the environment.
-   **Key Packages**:
    -   [**`dplyr`**](https://dplyr.tidyverse.org/): Provides verbs like `filter()`, `select()`, `slice()`, and supports pipe workflows.
    -   [**`magrittr`**](https://magrittr.tidyverse.org/): Provides `%>%` operator for chaining functions.

### 3.2.3 Vector Attribute Aggregation

-   Aggregation is summarizing data using one or more grouping variables, often leading to a smaller dataset. It is useful for data reduction, especially when working with large datasets.
-   **Base R Approach**
    -   **Using `aggregate()`**:
        -   Example: Calculating total population per continent.

            ``` r
            world_agg1 = aggregate(pop ~ continent, 
                                   FUN = sum, 
                                   data = world, 
                                   na.rm = TRUE)
            ```

            -   [**`aggregate()`**](https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/aggregate) groups data and applies a function (e.g., `sum`).
            -   Result: A non-spatial data frame with two columns (`continent`, `pop`).
    -   **Using `aggregate.sf()`**:
        -   For spatial objects (`sf`), use `aggregate()` with `by` argument:

            ``` r
            world_agg2 = aggregate(world["pop"], 
                                   by = list(world$continent), 
                                   FUN = sum, 
                                   na.rm = TRUE)
            ```

            -   This results in an **`sf`** object with eight features representing continents.
-   **`dplyr` Approach**
    -   **Using `group_by()` and `summarize()`**:
        -   Equivalent to `aggregate()`, but offers flexibility and control:

            ``` r
            library(dplyr)
            world_agg3 = world |>
              group_by(continent) |>
              summarize(pop = sum(pop, na.rm = TRUE))
            ```

            -   [**`group_by()`**](https://dplyr.tidyverse.org/reference/group_by.html) defines grouping variables.
            -   [**`summarize()`**](https://dplyr.tidyverse.org/reference/summarise.html) applies aggregation functions.
-   For more details, refer to the help pages of [`summarize()`](https://dplyr.tidyverse.org/reference/summarise.html) and the **dplyr** package vignette: `vignette(package = "dplyr")`.
-   Check [Chapter 5](https://r4ds.had.co.nz/transform.html) of [*R for Data Science*](https://r4ds.had.co.nz/).

### 3.2.4 Vector Attribute Joining

-   Joining involves combining tables based on a shared key variable. In R, `dplyr` functions like `left_join()` and `inner_join()` are commonly used for this purpose.

    -   The join functions in `dplyr` (`left_join`, `inner_join`, etc.) follow conventions from SQL, allowing easy and consistent data merging.
    -   These functions work similarly for both non-spatial (`data.frame`) and spatial (`sf`) objects. The geometry list column in `sf` objects is the key difference.

-   **When merging an `sf` object with a data.frame**

    -   The resulting object remains an `sf` object, keeping its spatial features intact while adding new columns for coffee production.

-   **Handling Key Variables**:

    -   If datasets have key variables with matching names (e.g., `name_long`), joining works automatically.
    -   If the key variables differ, either:
        -   Rename the variable to match, or
        -   Use the `by` argument to specify the joining variables explicitly.

-   **Inner Joins**:

    -   An **inner join** keeps only the rows with matching key variables in both datasets. This reduces the number of rows, depending on the overlap in key variables.

-   **Troubleshooting Joins**:

    -   If some rows are missing in the result (e.g., due to differing key names like "Congo, Dem. Rep. of"), identify mismatches using `setdiff()`.
    -   Use regex matching from the `stringr` package to identify correct key names for adjustments.

-   **Reversing Joins**:

    -   You can also join starting with a non-spatial dataset and adding spatial variables from an `sf` object.
    -   **The result will be a non-spatial `data.frame` (tibble), unless explicitly converted to an `sf` object using `st_as_sf()`.**

-   **Further Resources**:

    -   [Chapter 13](https://r4ds.had.co.nz/relational-data.html?q=join#relational-data) on Relational Data in [R for Data Science](https://r4ds.had.co.nz/relational-data.html?q=join#relational-data) by Grolemund and Wickham (2016)

    -   The [documentation](https://asardaes.github.io/table.express/articles/joins.html) describing joins with **`data.table`** package.

    -   The join [vignette](https://geocompx.github.io/geocompkg/articles/join.html) in the `geocompkg` package, which is summarized below: —

::: keylearning
**Spatial Joins Extended**

-   Spatial Joins: Combines attributes from different datasets based on a common key, useful for integrating non-spatial (attribute) data with spatial data.

#### Left Join

-   Adds attributes to all observations from the left dataset with matched values from the right.

#### Joining by Different Column Names

-   Case: If key columns have different names, use a named vector to specify the keys

-   Issue: Duplicate columns (e.g., `tbl_1_var.x` and `tbl_2_var.y`). Resolved by specifying all keys.

#### Joining with a Non-Spatial First Argument

-   Dropping Geometry: `st_drop_geometry()` removes spatial attributes, allowing joins with standard data frames.

#### Inner Join

-   Keeps only rows with matching keys in both datasets.
:::

### 3.2.5 Creating attributes and removing spatial information

-   **Creating new attributes**:
    -   Calculate a new attribute using `mutate()` from `dplyr`. Example: `population / area`.
    -   Use `mutate()` to add the new column without overwriting the geometry column.
-   **Combining columns**:
    -   Use [`unite()`](https://tidyr.tidyverse.org/reference/unite.html) from `tidyr` to merge two or more columns into one (e.g., `continent` and `region_un`).
    -   `unite()` allows setting a separator (e.g., `:`) and can optionally remove the original columns.
-   **Splitting columns**:
    -   Use [`separate_wider_position()`](https://tidyr.tidyverse.org/reference/separate_wider_delim.html) and [`separate_wider_delim()`](https://tidyr.tidyverse.org/reference/separate_wider_delim.html)from `tidyr` to split a combined column back into its original components.
-   **Renaming columns**:
    -   Use [`rename()`](https://dplyr.tidyverse.org/reference/rename.html) from `dplyr` for renaming specific columns.
    -   For renaming all columns, use [`setNames()`](https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/setNames) with a character vector for new names.
-   **Removing geometry**:
    -   Use [`st_drop_geometry()`](https://r-spatial.github.io/sf/reference/st_geometry.html) to drop the spatial information while retaining the attributes in a non-spatial `data.frame`. This method is preferred over manually selecting non-geometry columns as it avoids unintended issues.

## 3.3 Manipulating Raster Objects

-   **Raster Data Model**:
    -   Represents continuous surfaces, unlike vector data which use discrete entities (points, lines, polygons).
    -   Useful for representing spatial phenomena like elevation, temperature, and land cover.
-   **Creating a Raster Object**:
    -   Use `rast()` function to create raster objects.
    -   The `vals` argument assigns numeric values to each cell.
-   **Categorical Raster Values**:
    -   Can hold logical or factor (categorical) values.
    -   Example: Creating a raster for soil types (`clay`, `silt`, `sand`).
-   **Raster Attribute Table (RAT)**:
    -   Stores additional information about raster values, accessible with `cats()`.
    -   Each layer's attribute data can be modified with `levels()`.
-   **Color Table**:
    -   Categorical rasters can store color information using a color table with RGB (Red, Green, Blue) or RGBA (Red, Green, Blue, Alpha) columns.
    -   Use `coltab()` to view or set color tables.
    -   Saving the raster (e.g., as GeoTIFF) includes the color table information.

### **3.3.1 Raster subsetting**

*(under construction)*
